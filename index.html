<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BTV Police Training - Ghost Hunter Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --cobalt: #0051ff; --gold: #f0db4f; --danger: #ff4d4d; --success: #2ecc71; --bg: #050505; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #eee; margin: 0; display: flex; flex-direction: column; align-items: center; touch-action: manipulation; }
        .hud { width: 100%; max-width: 400px; padding: 15px; display: flex; justify-content: space-between; font-weight: bold; color: var(--gold); background: #111; border-bottom: 3px solid var(--cobalt); box-sizing: border-box; }
        #timer-display { color: var(--danger); font-size: 1.1rem; font-weight: bold; padding: 10px; height: 1.5rem; text-align: center; width: 100%; letter-spacing: 1px; }
        #game-container { position: relative; border: 5px solid var(--cobalt); background: #000; }
        canvas { display: block; touch-action: none; }
        #quiz-box { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 90%; background: #ffffff; border-radius: 4px; padding: 25px; 
            text-align: center; display: none; z-index: 100; color: #111; box-sizing: border-box;
            border: 4px solid var(--cobalt);
        }
        .optie { display: block; width: 100%; padding: 15px; margin: 10px 0; background: #eee; color: #111; border: 2px solid #ccc; cursor: pointer; border-radius: 4px; font-weight: 700; }
        .correct { background: var(--success) !important; color: white !important; }
        .fout { background: var(--danger) !important; color: white !important; }
        .panel { width: 95%; max-width: 380px; margin-top: 15px; background: #111; padding: 15px; border: 1px solid #333; }
        .btn { background: var(--cobalt); color: white; padding: 14px; width: 100%; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .score-row { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 6px 0; font-family: monospace; }
    </style>
</head>
<body>

<div id="login" style="margin-top: 50px; text-align: center;">
    <h1 style="color: var(--gold)">BTV PAC-MAN</h1>
    <input type="text" id="vnaam" placeholder="AGENT NAAM..." style="padding:15px; width:220px; background:#000; color:#fff; border:1px solid #333;"><br><br>
    <button class="btn" style="width:250px;" onclick="initSessie()">START TRAINING</button>
</div>

<div id="main-game" style="display:none;">
    <div class="hud">
        <span>SCORE: <span id="scr-val">0</span></span>
        <span>‚ù§Ô∏è: <span id="lvn-val">5</span></span>
    </div>
    <div id="timer-display">INITIALISEREN...</div>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="quiz-box">
            <div id="vraag" style="font-weight:800; margin-bottom:15px;"></div>
            <div id="optie-container"></div>
            <button id="btn-volgende" class="btn" style="display:none; background:#000; color:var(--success); border:2px solid var(--success);" onclick="nextQ()">VOLGENDE</button>
            <button id="restart-btn" style="display:none;" class="btn" onclick="location.reload()">HERSTARTEN</button>
        </div>
    </div>
    <div class="panel"><h3>LEADERBOARD</h3><div id="score-list">Laden...</div></div>
    <div class="panel"><textarea id="bulk-text" style="width:100%; height:60px;" placeholder="woord definitie..."></textarea><button class="btn" onclick="bulkAddWords()">IMPORT</button></div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBEod8zm1jvvkmPbe6cA_SQo2U_esC9yTY", databaseURL: "https://aangiftebotje-default-rtdb.europe-west1.firebasedatabase.app", projectId: "aangiftebotje" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let dynamicWords = [], vnaam, sRef, score = 0, level = 1, levens = 5, frame = 0, inGame = false, quizCount = 0, quizTarget = 3;
    let canvas, ctx, tileSize, pacman = { x: 9, y: 9, dir: {x:0, y:0}, nextDir: {x:0, y:0}, rotation: 0 };
    let dots = [], walls = [], ghosts = [], fruit = { x: -1, y: -1, active: false }, powerTimer = 0;
    let levelStartTime = 0, canAnswer = true;

    const mazeLayout = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
        [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,1,0,1,0,1,1,1,1,1,1,1,1,1,0,1,0,1,1],
        [1,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,1],
        [1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1],
        [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
        [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
        [1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];

    function bulkAddWords() {
        const text = document.getElementById('bulk-text').value.trim();
        text.split('\n').forEach(line => {
            const p = line.trim().split(/\s+/);
            if(p.length > 1) { const v = p.shift(); const m = p.join(' '); db.ref('woorden').push({v, m}); }
        });
        alert("Opgeslagen.");
    }

    function initSessie() {
        vnaam = document.getElementById('vnaam').value.trim();
        if(!vnaam) return alert("Naam?");
        db.ref('woorden').once('value', snap => {
            if(!snap.exists()) return alert("Database leeg!");
            dynamicWords = Object.values(snap.val()).filter(w => w.v && w.m);
            sRef = db.ref('ranking').push({ naam: vnaam, score: 0 });
            document.getElementById('login').style.display = 'none';
            document.getElementById('main-game').style.display = 'block';
            updateScoreboard(); setupCanvas();
            startQuiz(3);
        });
    }

    function startQuiz(num) {
        inGame = false; quizCount = 0; quizTarget = num;
        document.getElementById('quiz-box').style.display = 'block';
        nextQ();
    }

    function nextQ() {
        if(quizCount >= quizTarget) { 
            document.getElementById('quiz-box').style.display = 'none'; 
            levelStartTime = Date.now(); inGame = true; initLevel(); requestAnimationFrame(gameLoop); 
            return; 
        }
        canAnswer = true;
        document.getElementById('btn-volgende').style.display = 'none';
        const q = dynamicWords[Math.floor(Math.random()*dynamicWords.length)];
        let others = dynamicWords.map(w => w.m).filter(m => m !== q.m).sort(() => 0.5 - Math.random());
        let opties = [q.m, others[0] || "Fout A", others[1] || "Fout B"].sort(() => 0.5 - Math.random());
        document.getElementById('vraag').innerText = q.v.toUpperCase();
        const cont = document.getElementById('optie-container'); cont.innerHTML = '';
        opties.forEach(o => {
            const b = document.createElement('button'); b.className = 'optie'; b.innerText = o;
            b.onclick = () => {
                if(!canAnswer) return;
                canAnswer = false;
                if(o === q.m) { b.classList.add('correct'); setTimeout(() => { quizCount++; nextQ(); }, 600); }
                else { b.classList.add('fout'); Array.from(cont.children).forEach(btn => { if(btn.innerText === q.m) btn.classList.add('correct'); }); document.getElementById('btn-volgende').style.display = 'block'; quizCount++; }
            };
            cont.appendChild(b);
        });
    }

    function setupCanvas() {
        canvas = document.getElementById('gameCanvas'); ctx = canvas.getContext('2d');
        const s = Math.min(window.innerWidth * 0.95, 400); tileSize = Math.floor(s/19);
        canvas.width = tileSize*19; canvas.height = tileSize*11;
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const tx = e.touches[0].clientX - rect.left; const ty = e.touches[0].clientY - rect.top;
            const cx = canvas.width/2; const cy = canvas.height/2;
            if(Math.abs(tx-cx) > Math.abs(ty-cy)) pacman.nextDir = tx > cx ? {x:1, y:0} : {x:-1, y:0};
            else pacman.nextDir = ty > cy ? {x:0, y:1} : {x:0, y:-1};
        }, {passive: false});
    }

    function initLevel() {
        dots = []; walls = [];
        for(let y=0; y<11; y++) for(let x=0; x<19; x++) {
            if(mazeLayout[y][x] === 1) walls.push({x, y});
            else if(mazeLayout[y][x] === 0) dots.push({x, y, eaten: false});
        }
        pacman.x = 9; pacman.y = 9; pacman.dir = {x:0, y:0}; pacman.nextDir = {x:0, y:0}; pacman.rotation = 0;
        ghosts = [{x:9, y:5, color:'#ff0000', speed: 0.04}, {x:8, y:5, color:'#ffb8ff', speed: 0.035}];
        fruit.active = false; powerTimer = 0;
    }

    function gameLoop() {
        if(!inGame) return;
        frame++;
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
        
        // Muren Tekenen
        ctx.fillStyle = '#0022aa';
        walls.forEach(w => {
            ctx.fillRect(w.x*tileSize+1, w.y*tileSize+1, tileSize-2, tileSize-2);
            ctx.strokeStyle = '#0077ff'; ctx.strokeRect(w.x*tileSize+3, w.y*tileSize+3, tileSize-6, tileSize-6);
        });
        
        // Dots & Fruit
        ctx.fillStyle = '#fff';
        dots.forEach(d => { if(!d.eaten){ ctx.beginPath(); ctx.arc(d.x*tileSize+tileSize/2, d.y*tileSize+tileSize/2, 2, 0, 7); ctx.fill(); }});
        
        if(frame % 600 === 0 && !fruit.active) { 
            let empty = dots.filter(d => !d.eaten);
            if(empty.length > 0) { let r = empty[Math.floor(Math.random()*empty.length)]; fruit.x = r.x; fruit.y = r.y; fruit.active = true; }
        }
        if(fruit.active) {
            ctx.fillStyle = '#ff0000'; ctx.beginPath(); ctx.arc(fruit.x*tileSize+tileSize/2, fruit.y*tileSize+tileSize/2, tileSize/3, 0, 7); ctx.fill();
            if(Math.hypot(pacman.x-fruit.x, pacman.y-fruit.y) < 0.6) { fruit.active = false; powerTimer = 400; score += 50; }
        }

        // Pac-Man Beweging & Rotatie
        if(Number.isInteger(pacman.x) && Number.isInteger(pacman.y)) {
            let d = dots.find(dot => dot.x === pacman.x && dot.y === pacman.y && !dot.eaten);
            if(d){ d.eaten = true; score += 10; document.getElementById('scr-val').innerText = score; sRef.update({score}); }
            if(canM(pacman.x+pacman.nextDir.x, pacman.y+pacman.nextDir.y)) pacman.dir = pacman.nextDir;
            if(!canM(pacman.x+pacman.dir.x, pacman.y+pacman.dir.y)) pacman.dir = {x:0, y:0};
            if(pacman.dir.x === 1) pacman.rotation = 0; if(pacman.dir.x === -1) pacman.rotation = Math.PI;
            if(pacman.dir.y === 1) pacman.rotation = Math.PI/2; if(pacman.dir.y === -1) pacman.rotation = -Math.PI/2;
        }
        pacman.x = Math.round((pacman.x + pacman.dir.x*0.1)*10)/10; pacman.y = Math.round((pacman.y + pacman.dir.y*0.1)*10)/10;
        
        ctx.save(); ctx.translate(pacman.x*tileSize+tileSize/2, pacman.y*tileSize+tileSize/2); ctx.rotate(pacman.rotation);
        ctx.fillStyle = 'yellow'; ctx.beginPath(); let m = Math.abs(Math.sin(frame*0.15))*0.2;
        ctx.arc(0,0, tileSize/2-2, (0.2+m)*Math.PI, (1.8-m)*Math.PI); ctx.lineTo(0,0); ctx.fill(); ctx.restore();

        // Spookjes & Timer
        let diff = Math.floor((20000 - (Date.now() - levelStartTime)) / 1000);
        document.getElementById('timer-display').innerText = powerTimer > 0 ? "üî• GHOST HUNT ACTIVE!" : (diff > 0 ? `üö® SPOOKJES IN: ${diff}s` : "üèÉ REN!");
        if(powerTimer > 0) powerTimer--;

        ghosts.forEach(g => {
            if(powerTimer > 0) {
                ctx.fillStyle = '#0000ff'; g.x += (pacman.x > g.x ? -0.4 : 0.4) * g.speed; g.y += (pacman.y > g.y ? -0.4 : 0.4) * g.speed;
            } else {
                ctx.fillStyle = g.color; ctx.globalAlpha = diff > 0 ? 0.3 : 1;
                if(diff <= 0) { g.x += (pacman.x > g.x ? 1 : -1) * g.speed; g.y += (pacman.y > g.y ? 1 : -1) * g.speed; }
            }
            ctx.beginPath(); ctx.arc(g.x*tileSize+tileSize/2, g.y*tileSize+tileSize/2, tileSize/2-2, 0, 7); ctx.fill(); ctx.globalAlpha = 1;

            if(Math.hypot(pacman.x-g.x, pacman.y-g.y) < 0.7) {
                if(powerTimer > 0) { g.x = 9; g.y = 5; score += 200; }
                else if(diff <= 0) { 
                    levens--; document.getElementById('lvn-val').innerText = levens;
                    if(levens <= 0) { inGame=false; document.getElementById('quiz-box').style.display='block'; document.getElementById('vraag').innerText = "GAME OVER"; document.getElementById('restart-btn').style.display='block'; }
                    else startQuiz(2);
                }
            }
        });
        requestAnimationFrame(gameLoop);
    }
    function canM(x,y) { if(x<0 || x>18 || y<0 || y>10) return false; return !walls.some(w => w.x===x && w.y===y); }
    function updateScoreboard() { db.ref('ranking').orderByChild('score').limitToLast(5).on('value', snap => {
        const list = document.getElementById('score-list'); list.innerHTML = '';
        let res = []; snap.forEach(s => res.push(s.val()));
        res.reverse().forEach(r => list.innerHTML += `<div class="score-row"><span>${r.naam}</span><span>${r.score}</span></div>`);
    }); }
</script>
</body>
</html>
