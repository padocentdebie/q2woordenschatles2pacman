<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTV Police - Tactical Escape Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --cobalt: #0044ff; --gold: #f0db4f; --danger: #ff0000; --success: #2ecc71; --bg: #000; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #eee; margin: 0; display: flex; flex-direction: column; align-items: center; overflow: hidden; touch-action: none; }
        .hud { width: 380px; padding: 10px; display: flex; justify-content: space-between; font-weight: bold; color: var(--gold); background: #111; border-bottom: 3px solid var(--cobalt); }
        #game-container { position: relative; border: 4px solid #222; background: #000; margin-top: 10px; display: none; }
        canvas { display: block; }
        #quiz-box, #name-box { width: 340px; background: #fff; border-radius: 12px; padding: 20px; text-align: center; color: #000; border: 5px solid var(--cobalt); margin-top: 50px; }
        .optie { display: block; width: 100%; padding: 12px; margin: 8px 0; background: #f0f0f0; border: 2px solid #ccc; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .correct { background: var(--success) !important; color: #fff; }
        .fout { background: var(--danger) !important; color: #fff; }
        .btn { background: var(--cobalt); color: white; padding: 12px; width: 100%; border: none; font-weight: bold; cursor: pointer; border-radius: 6px; }
        #leaderboard { width: 380px; margin-top: 15px; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .lb-entry { display: flex; justify-content: space-between; padding: 4px; font-size: 0.85rem; border-bottom: 1px solid #222; }
        .speed-control { background: #222; padding: 10px; border-radius: 8px; margin-top: 10px; width: 360px; text-align: center; font-size: 0.8rem; border: 1px solid var(--cobalt); }
        input[type=range] { width: 80%; cursor: pointer; }
    </style>
</head>
<body>

<div class="speed-control" id="admin-speed" style="display:none;">
    <label>Snelheid Verdachten: <span id="speed-val">0.06</span></label><br>
    <input type="range" min="0.01" max="0.20" step="0.01" value="0.06" oninput="updateGhostSpeed(this.value)">
</div>

<div id="quiz-box">
    <h2 id="quiz-status" style="color:var(--cobalt); margin:0;">AGENT EXAMEN</h2>
    <p id="progress-text">Voortgang: 0/5</p>
    <div id="vraag" style="font-weight:800; margin-bottom:15px; min-height:40px;">Laden...</div>
    <div id="optie-container"></div>
    <button id="btn-retry" class="btn" style="display:none; background:var(--danger);" onclick="resetQuiz()">FOUT! OPNIEUW</button>
</div>

<div id="name-box" style="display:none;">
    <h2 style="color:var(--cobalt);">GESLAAGD!</h2>
    <input type="text" id="agent-name" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="Je naam...">
    <button class="btn" onclick="startArrestMode()">START SURVEILLANCE</button>
</div>

<div id="main-game" style="display:none; text-align:center;">
    <div class="hud">
        <span>SCORE: <span id="scr-val">0</span></span>
        <span>LEVEL: <span id="lvl-val">1</span></span>
        <span>TIJD: <span id="timer-val">120</span></span>
    </div>
    <div id="game-container"><canvas id="gameCanvas"></canvas></div>
</div>

<div id="leaderboard">
    <h4 style="margin:0 0 5px 0; color:var(--cobalt); text-align:center;">TOP AGENTEN</h4>
    <div id="lb-list">...</div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBEod8zm1jvvkmPbe6cA_SQo2U_esC9yTY", databaseURL: "https://aangiftebotje-default-rtdb.europe-west1.firebasedatabase.app", projectId: "aangiftebotje" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let dynamicWords = [], score = 0, frame = 0, inGame = false, quizCount = 0, lightOn = true, agentName = "";
    let canvas, ctx, tileSize = 20;
    let pacman = { x: 9, y: 9, dir: {x:0, y:0}, nextDir: {x:0, y:0} };
    let dots = [], walls = [], ghosts = [], ghostBaseSpeed = 0.06; 
    let timeLeft = 120, currentLevel = 1, timerInterval;

    function updateGhostSpeed(val) {
        ghostBaseSpeed = parseFloat(val);
        document.getElementById('speed-val').innerText = val;
    }

    const maze = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
        [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,1,0,1,0,1,1,1,1,1,1,1,1,1,0,1,0,1,1],
        [0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0], 
        [1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1],
        [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
        [1,0,1,1,0,1,1,1,0,0,0,1,1,1,0,1,1,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];

    function loadWords() {
        db.ref('woorden').once('value', snap => { if(snap.exists()){ dynamicWords = Object.values(snap.val()); showQuestion(); }});
        updateLeaderboard();
    }

    function showQuestion() {
        if(quizCount >= 5) { document.getElementById('quiz-box').style.display='none'; document.getElementById('name-box').style.display='block'; return; }
        document.getElementById('progress-text').innerText = `Voortgang: ${quizCount}/5`;
        document.getElementById('btn-retry').style.display = 'none';
        const q = dynamicWords[Math.floor(Math.random()*dynamicWords.length)];
        let others = dynamicWords.filter(w => w.m !== q.m).map(w => w.m).sort(() => 0.5 - Math.random());
        let opties = [q.m, others[0], others[1]].sort(() => 0.5 - Math.random());
        document.getElementById('vraag').innerText = q.v;
        const cont = document.getElementById('optie-container'); cont.innerHTML = '';
        opties.forEach(o => {
            const b = document.createElement('button'); b.className='optie'; b.innerText=o;
            b.onclick = () => {
                if(o === q.m) { b.classList.add('correct'); quizCount++; setTimeout(showQuestion, 600); }
                else { b.classList.add('fout'); document.getElementById('btn-retry').style.display='block'; }
            };
            cont.appendChild(b);
        });
    }

    function startArrestMode() {
        agentName = document.getElementById('agent-name').value || "Agent";
        document.getElementById('name-box').style.display = 'none';
        document.getElementById('main-game').style.display = 'block';
        document.getElementById('game-container').style.display = 'block';
        document.getElementById('admin-speed').style.display = 'block';
        setupCanvas(); initLevel(1); requestAnimationFrame(gameLoop);
    }

    function initLevel(level) {
        currentLevel = level;
        timeLeft = 120;
        dots = []; walls = [];
        for(let y=0; y<maze.length; y++) for(let x=0; x<maze[y].length; x++) {
            if(maze[y][x] === 1) walls.push({x, y});
            else if(maze[y][x] === 0 || maze[y][x] === 2) dots.push({x, y, eaten: false});
        }
        pacman.x = 9; pacman.y = 9; pacman.dir = {x:0, y:0};
        ghosts = [{x:1, y:1, color:'red', vx:0, vy:0}, {x:17, y:1, color:'pink', vx:0, vy:0}];
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => { 
            if(inGame) { 
                timeLeft--; 
                document.getElementById('timer-val').innerText = timeLeft;
                if(timeLeft === 90) addGhost('lime');
                if(timeLeft === 60) addGhost('orange');
                if(timeLeft === 30) addGhost('cyan');
                if(timeLeft <= 0) gameOver(); 
            }
        }, 1000);
        inGame = true;
    }

    function addGhost(color) {
        let pos = getRandomEmptyPos();
        ghosts.push({x: pos.x, y: pos.y, color: color, vx:0, vy:0});
    }

    function getRandomEmptyPos() {
        let emptyCells = [];
        for(let y=0; y<maze.length; y++) {
            for(let x=0; x<maze[y].length; x++) {
                if(maze[y][x] !== 1) emptyCells.push({x, y});
            }
        }
        return emptyCells[Math.floor(Math.random() * emptyCells.length)];
    }

    function canMove(x, y) {
        let rx = Math.round(x); let ry = Math.round(y);
        if(ry === 5 && (rx < 0 || rx > 18)) return true;
        if(!maze[ry] || maze[ry][rx] === 1) return false;
        return true;
    }

    function gameOver() {
        inGame = false; clearInterval(timerInterval);
        db.ref('leaderboard').push({ name: agentName, score: score });
        alert(`TIJD IS OM! EINDE DIENST!\nScore: ${score}`);
        location.reload();
    }

    function setupCanvas() {
        canvas = document.getElementById('gameCanvas'); ctx = canvas.getContext('2d');
        canvas.width = 19 * tileSize; canvas.height = 11 * tileSize;
        window.addEventListener('keydown', e => {
            if(e.key.includes("Up")) pacman.nextDir = {x:0, y:-1};
            if(e.key.includes("Down")) pacman.nextDir = {x:0, y:1};
            if(e.key.includes("Left")) pacman.nextDir = {x:-1, y:0};
            if(e.key.includes("Right")) pacman.nextDir = {x:1, y:0};
        });
    }

    function updateLeaderboard() {
        db.ref('leaderboard').orderByChild('score').limitToLast(5).once('value', snap => {
            let html = ""; let arr = []; snap.forEach(s => arr.push(s.val()));
            arr.reverse().forEach((e, i) => html += `<div class="lb-entry"><span>${i+1}. ${e.name}</span><span>${e.score}</span></div>`);
            document.getElementById('lb-list').innerHTML = html;
        });
    }

    function gameLoop() {
        if(!inGame) return;
        frame++; if(frame % 15 === 0) lightOn = !lightOn;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#0022aa'; walls.forEach(w => ctx.fillRect(w.x*tileSize+1, w.y*tileSize+1, tileSize-2, tileSize-2));
        ctx.fillStyle = '#fff'; dots.forEach(d => { if(!d.eaten) { ctx.beginPath(); ctx.arc(d.x*tileSize+tileSize/2, d.y*tileSize+tileSize/2, 2, 0, 7); ctx.fill(); }});

        if(Math.abs(pacman.x - Math.round(pacman.x)) < 0.1 && Math.abs(pacman.y - Math.round(pacman.y)) < 0.1) {
            if(canMove(Math.round(pacman.x + pacman.nextDir.x), Math.round(pacman.y + pacman.nextDir.y))) pacman.dir = pacman.nextDir;
            if(!canMove(Math.round(pacman.x + pacman.dir.x), Math.round(pacman.y + pacman.dir.y))) pacman.dir = {x:0, y:0};
        }
        pacman.x += pacman.dir.x * 0.12; pacman.y += pacman.dir.y * 0.12;
        if(pacman.x < -0.6) pacman.x = 18.6; if(pacman.x > 18.6) pacman.x = -0.6;

        ctx.fillStyle = 'yellow'; ctx.beginPath(); ctx.arc(pacman.x*tileSize+tileSize/2, pacman.y*tileSize+tileSize/2, 8, 0, 7); ctx.fill();
        if(lightOn) { ctx.fillStyle = '#00f'; ctx.beginPath(); ctx.arc(pacman.x*tileSize+tileSize/2, pacman.y*tileSize+tileSize/2 - 5, 4, 0, 7); ctx.fill(); }

        ghosts.forEach(g => {
            if(Math.round(g.y) === 5 && (g.x < 1 || g.x > 17)) {} 
            else if(Math.abs(g.x - Math.round(g.x)) < 0.1 && Math.abs(g.y - Math.round(g.y)) < 0.1) {
                let dist = Math.hypot(pacman.x - g.x, pacman.y - g.y);
                let dx, dy;

                if (dist < 4) { // --- NIEUWE LOGICA: VLUCHTEN ---
                    dx = pacman.x > g.x ? -1 : 1; // Precies andersom dan Pacman
                    dy = pacman.y > g.y ? -1 : 1;
                } else { // Normaal jagen
                    dx = pacman.x > g.x ? 1 : -1;
                    dy = pacman.y > g.y ? 1 : -1;
                }

                if(Math.abs(pacman.x - g.x) > Math.abs(pacman.y - g.y)) {
                    if(canMove(Math.round(g.x + dx), Math.round(g.y))) { g.vx = dx; g.vy = 0; }
                    else if(canMove(Math.round(g.x), Math.round(g.y + dy))) { g.vx = 0; g.vy = dy; }
                } else {
                    if(canMove(Math.round(g.x), Math.round(g.y + dy))) { g.vx = 0; g.vy = dy; }
                    else if(canMove(Math.round(g.x + dx), Math.round(g.y))) { g.vx = dx; g.vy = 0; }
                }
            }
            g.x += g.vx * (ghostBaseSpeed + currentLevel*0.01);
            g.y += g.vy * (ghostBaseSpeed + currentLevel*0.01);
            if(g.x < -0.6) g.x = 18.6; if(g.x > 18.6) g.x = -0.6;
            
            let d = dots.find(dot => Math.round(dot.x) === Math.round(g.x) && Math.round(dot.y) === Math.round(g.y) && !dot.eaten);
            if(d) { d.eaten = true; score -= 10; }
            
            ctx.fillStyle = g.color; ctx.beginPath(); ctx.arc(g.x*tileSize+tileSize/2, g.y*tileSize+tileSize/2, 8, 0, 7); ctx.fill();
            
            if(Math.hypot(pacman.x-g.x, pacman.y-g.y) < 0.8) {
                score += 100; 
                let newPos = getRandomEmptyPos();
                g.x = newPos.x;
                g.y = newPos.y;
                if(score >= currentLevel * 600) {
                     currentLevel++;
                     document.getElementById('lvl-val').innerText = currentLevel;
                }
            }
        });
        document.getElementById('scr-val').innerText = score;
        requestAnimationFrame(gameLoop);
    }
    loadWords();
</script>
</body>
</html>
