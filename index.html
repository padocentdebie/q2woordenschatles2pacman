<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BTV Police Training</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --cobalt: #1a2a6c; --gold: #f0db4f; --danger: #e74c3c; --bg: #0a0a0a; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: #eee; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        /* HUD & Game */
        .hud { width: 400px; padding: 15px; display: flex; justify-content: space-between; font-weight: bold; color: var(--gold); }
        #game-container { position: relative; border: 4px solid var(--cobalt); border-radius: 8px; overflow: hidden; }
        
        /* Quiz - Rustige Lay-out */
        #quiz-box { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 85%; background: #ffffff; border-radius: 15px; padding: 25px; 
            text-align: center; display: none; z-index: 100; color: #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #vraag { font-size: 1.1rem; color: #111; margin-bottom: 20px; font-weight: 600; line-height: 1.5; }
        .optie { 
            display: block; width: 100%; padding: 14px; margin: 10px 0; 
            background: #f8f9fa; color: #333; border: 2px solid #dee2e6; 
            cursor: pointer; border-radius: 10px; font-size: 0.95rem; transition: all 0.2s;
        }
        .optie:hover { background: var(--cobalt); color: #fff; border-color: var(--cobalt); }
        
        /* Panelen */
        .panel { width: 380px; margin-top: 20px; background: #161616; border-radius: 12px; padding: 20px; border: 1px solid #333; }
        h3 { margin-top: 0; color: var(--gold); text-align: center; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 1px; }
        
        textarea { width: 100%; height: 100px; padding: 10px; box-sizing: border-box; background: #222; color: #fff; border: 1px solid #444; border-radius: 6px; resize: none; }
        .btn { background: var(--cobalt); color: white; padding: 12px; width: 100%; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-red { background: transparent; color: var(--danger); border: 1px solid var(--danger); font-size: 0.75rem; margin-top: 15px; }

        .score-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #222; font-size: 0.9rem; }
        .gold-text { color: var(--gold); }
    </style>
</head>
<body>

<div id="login" style="margin-top: 80px; text-align: center;">
    <h1 style="color: var(--gold); letter-spacing: 4px;">BTV PAC-MAN</h1>
    <input type="text" id="vnaam" placeholder="Naam agent..." style="padding:15px; width:250px; border-radius:8px; border:1px solid #333; background:#111; color:#fff;"><br><br>
    <button class="btn" style="width:280px;" onclick="initSessie()">START TRAINING</button>
</div>

<div id="main-game" style="display:none;">
    <div class="hud">
        <span>SCORE: <span id="scr-val">0</span></span>
        <span>LEVEL: <span id="lvl-val">1</span></span>
        <span>‚ù§Ô∏è: <span id="lvn-val">5</span></span>
    </div>
    
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="quiz-box">
            <div id="quiz-content">
                <p id="vraag"></p>
                <div id="optie-container"></div>
            </div>
            <button id="restart-btn" style="display:none;" class="btn" onclick="location.reload()">HERSTARTEN</button>
        </div>
    </div>

    <div class="panel">
        <h3>üèÜ HALL OF FAME</h3>
        <div id="score-list">Laden...</div>
        <button class="btn btn-red" onclick="resetScores()">WIS SCORES</button>
    </div>

    <div class="panel" style="margin-bottom: 50px;">
        <h3>üõ† BEHEER</h3>
        <textarea id="bulk-text" placeholder="plak hier woorden en hun betekenis"></textarea>
        <button class="btn" onclick="bulkAddWords()">IMPORTLIJST OPSLAAN</button>
        <button class="btn btn-red" onclick="clearWords()">WIS WOORDENLIJST</button>
        <p id="fb" style="text-align:center; color: #2ecc71; font-size: 0.8rem;"></p>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBEod8zm1jvvkmPbe6cA_SQo2U_esC9yTY",
        databaseURL: "https://aangiftebotje-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "aangiftebotje"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let dynamicWords = [];
    let vnaam, sRef, score = 0, level = 1, levens = 5, frame = 0, inGame = false, quizCount = 0, quizTarget = 3;
    let canvas, ctx, tileSize, pacman = { x: 9, y: 15, dir: {x:0, y:0}, nextDir: {x:0, y:0} }, dots = [], walls = [], ghosts = [];

    const mazeLayout = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
        [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],
        [1,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,1],
        [1,1,1,1,0,1,1,1,2,1,2,1,1,1,0,1,1,1,1],
        [2,2,2,2,0,2,2,2,2,2,2,2,2,2,0,2,2,2,2],
        [1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1],
        [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
        [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
        [1,0,0,1,0,0,0,0,0,2,0,0,0,0,0,1,0,0,1],
        [1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],
        [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];

    function resetScores() { if(confirm("Hall of Fame wissen?")) db.ref('ranking').remove(); }
    function clearWords() { if(confirm("Woordenlijst wissen?")) db.ref('woorden').remove(); }

    function bulkAddWords() {
        const text = document.getElementById('bulk-text').value.trim();
        if(!text) return;
        const lines = text.split('\n');
        lines.forEach(line => {
            const p = line.trim().split(' ');
            if(p.length > 1) {
                const w = p.shift();
                const m = p.join(' ');
                db.ref('woorden').push({v: w, m: m});
            }
        });
        document.getElementById('bulk-text').value = "";
        document.getElementById('fb').innerText = "‚úÖ Lijst succesvol opgeslagen!";
        setTimeout(() => document.getElementById('fb').innerText = "", 3000);
    }

    function initSessie() {
        vnaam = document.getElementById('vnaam').value;
        if(!vnaam) return alert("Voer je naam in.");
        sRef = db.ref('ranking').push({ naam: vnaam, score: 0 });
        document.getElementById('login').style.display = 'none';
        document.getElementById('main-game').style.display = 'block';
        db.ref('woorden').on('value', snap => { 
            dynamicWords = snap.exists() ? Object.values(snap.val()) : [];
        });
        updateScoreboard(); setupCanvas();
        setTimeout(() => {
            if(dynamicWords.length < 3) alert("Let op: Voeg eerst woorden toe onderaan!");
            startQuiz(3); 
        }, 1000);
    }

    function startQuiz(num) {
        inGame = false; quizCount = 0; quizTarget = num;
        document.getElementById('quiz-box').style.display = 'block';
        nextQ();
    }

    function nextQ() {
        if(quizCount >= quizTarget) { 
            document.getElementById('quiz-box').style.display='none'; 
            inGame=true; initLevel(); requestAnimationFrame(gameLoop); 
            return; 
        }
        const q = dynamicWords[Math.floor(Math.random()*dynamicWords.length)];
        const correct = q.m;
        let distractors = dynamicWords.filter(w => w.m !== correct).map(w => w.m).sort(()=>0.5-Math.random()).slice(0,2);
        while(distractors.length < 2) distractors.push("Onjuist alternatief " + (distractors.length+1));
        
        const opties = [correct, ...distractors].sort(()=>0.5-Math.random());
        document.getElementById('vraag').innerText = `Vraag ${quizCount+1}: Wat is de betekenis van "${q.v}"?`;
        const cont = document.getElementById('optie-container'); cont.innerHTML = '';
        opties.forEach(o => {
            let b = document.createElement('button'); b.className='optie'; b.innerText=o;
            b.onclick = () => { if(o===correct){ quizCount++; nextQ(); } else alert("Fout! Probeer het opnieuw."); };
            cont.appendChild(b);
        });
    }

    function setupCanvas() {
        canvas = document.getElementById('gameCanvas'); ctx = canvas.getContext('2d');
        const s = Math.min(window.innerWidth * 0.95, 400); tileSize = Math.floor(s/19);
        canvas.width = tileSize*19; canvas.height = tileSize*15;
    }

    function initLevel() {
        dots = []; walls = [];
        for(let y=0; y<15; y++) for(let x=0; x<19; x++) {
            if(mazeLayout[y][x] === 1) walls.push({x, y});
            else if(mazeLayout[y][x] === 0) dots.push({x, y, eaten: false});
        }
        pacman.x = 9; pacman.y = 11; pacman.dir = {x:0, y:0};
        ghosts = [
            {x:9, y:7, color:'red', speed: 0.04 + (level*0.01)},
            {x:8, y:7, color:'#ffb8ff', speed: 0.03 + (level*0.01)}
        ];
    }

    function gameLoop() {
        if(!inGame) return;
        frame++; ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
        
        ctx.strokeStyle = '#1a2a6c'; ctx.lineWidth = 2;
        walls.forEach(w => ctx.strokeRect(w.x*tileSize+2, w.y*tileSize+2, tileSize-4, tileSize-4));
        ctx.fillStyle = '#fff'; 
        let remaining = 0;
        dots.forEach(d => { if(!d.eaten){ remaining++; ctx.beginPath(); ctx.arc(d.x*tileSize+tileSize/2, d.y*tileSize+tileSize/2, 2, 0, 7); ctx.fill(); }});

        if(remaining === 0) { level++; document.getElementById('lvl-val').innerText = level; initLevel(); }

        if(Number.isInteger(pacman.x) && Number.isInteger(pacman.y)) {
            let d = dots.find(dot => dot.x === pacman.x && dot.y === pacman.y && !dot.eaten);
            if(d){ d.eaten = true; score += 10; document.getElementById('scr-val').innerText = score; sRef.update({score}); }
            if(canM(pacman.x + pacman.nextDir.x, pacman.y + pacman.nextDir.y)) pacman.dir = pacman.nextDir;
            if(!canM(pacman.x + pacman.dir.x, pacman.y + pacman.dir.y)) pacman.dir = {x:0, y:0};
        }
        pacman.x = Math.round((pacman.x + pacman.dir.x*0.1)*10)/10; pacman.y = Math.round((pacman.y + pacman.dir.y*0.1)*10)/10;
        
        ctx.fillStyle = 'yellow'; ctx.beginPath();
        ctx.arc(pacman.x*tileSize+tileSize/2, pacman.y*tileSize+tileSize/2, tileSize/2-1, 0.2*Math.PI, 1.8*Math.PI);
        ctx.lineTo(pacman.x*tileSize+tileSize/2, pacman.y*tileSize+tileSize/2); ctx.fill();

        ghosts.forEach(g => {
            g.x += (pacman.x > g.x ? 1 : -1) * g.speed; g.y += (pacman.y > g.y ? 1 : -1) * g.speed;
            ctx.fillStyle = g.color; ctx.beginPath(); ctx.arc(g.x*tileSize+tileSize/2, g.y*tileSize+tileSize/2, tileSize/2-1, 0, 7); ctx.fill();
            if(Math.hypot(pacman.x-g.x, pacman.y-g.y) < 0.7) {
                levens--; document.getElementById('lvn-val').innerText = levens;
                if(levens <= 0) { 
                    inGame = false; 
                    document.getElementById('quiz-box').style.display='block'; 
                    document.getElementById('vraag').innerText = "GAME OVER. Je score: " + score;
                    document.getElementById('optie-container').innerHTML = '';
                    document.getElementById('restart-btn').style.display='block';
                } else startQuiz(2);
            }
        });
        requestAnimationFrame(gameLoop);
    }
    function canM(x,y) { if(x<0 || x>18 || y<0 || y>14) return false; return !walls.some(w => w.x===x && w.y===y); }
    function updateScoreboard() { db.ref('ranking').orderByChild('score').limitToLast(5).on('value', snap => {
        const list = document.getElementById('score-list'); list.innerHTML = '';
        let res = []; snap.forEach(s => res.push(s.val()));
        res.reverse().forEach((r, i) => list.innerHTML += `<div class="score-row ${i===0?'gold-text':''}"><span>${r.naam}</span><span>${r.score}</span></div>`);
    }); }
    window.addEventListener('keydown', e => {
        if(e.key === 'ArrowLeft') pacman.nextDir = {x:-1, y:0};
        if(e.key === 'ArrowRight') pacman.nextDir = {x:1, y:0};
        if(e.key === 'ArrowUp') pacman.nextDir = {x:0, y:-1};
        if(e.key === 'ArrowDown') pacman.nextDir = {x:0, y:1};
    });
</script>
</body>
</html>
