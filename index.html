<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>BTV Pac-Man: Level Up Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --btv: #003159; --geel: #f0db4f; --bg: #050505; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        .game-wrapper { display: flex; gap: 20px; padding: 20px; width: 98vw; height: 90vh; }
        
        /* Leaderboard Links */
        #side-ranking { background: #111; border: 1px solid #333; border-radius: 12px; flex: 1; padding: 15px; overflow-y: auto; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #222; font-family: monospace; }
        .gold { color: var(--geel); font-weight: bold; }

        /* Game & Quiz Center */
        #stage { background: #fff; color: #333; border-radius: 15px; flex: 2; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        canvas { background: #000; border: 5px solid #222; display: none; }
        
        /* Quiz UI */
        #quiz-box { width: 80%; text-align: center; }
        .optie { display: block; width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 1.1rem; background: #fff; }
        .optie:hover { background: #f0f7ff; border-color: var(--btv); }
        
        .hud { width: 100%; display: flex; justify-content: space-around; padding: 10px; background: #eee; color: var(--btv); font-weight: bold; position: absolute; top: 0; }
    </style>
</head>
<body>

<div class="game-wrapper">
    <div id="side-ranking">
        <h2 style="color: var(--geel); margin-top: 0;">TOP SCORES</h2>
        <div id="ranking-list">Laden...</div>
    </div>

    <div id="stage">
        <div id="login-screen">
            <h2>BTV Woordenschat Training</h2>
            <input type="text" id="vnaam" placeholder="Alleen voornaam..." style="padding: 10px; font-size: 1rem; border-radius: 5px; border: 1px solid #ccc;">
            <button onclick="initSessie()" style="padding: 10px 20px; background: var(--btv); color: white; border: none; border-radius: 5px; cursor: pointer;">START</button>
        </div>

        <div id="quiz-box" style="display:none;">
            <h3 id="q-status">Beantwoord 5 vragen</h3>
            <h2 id="vraag">...</h2>
            <div id="optie-container"></div>
        </div>

        <div id="game-container" style="display:none; width: 100%; height: 100%;">
            <div class="hud">
                <span>LVL: <span id="lvl-val">1</span></span>
                <span>PUNTEN: <span id="scr-val">0</span></span>
                <span>LEVENS: <span id="lvn-val">3</span></span>
            </div>
            <canvas id="gameCanvas" width="400" height="400"></canvas>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = {
        apiKey: "AIzaSyBEod8zm1jvvkmPbe6cA_SQo2U_esC9yTY",
        databaseURL: "https://aangiftebotje-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "aangiftebotje"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- GAME DATA & STATE ---
    let sRef = null;
    let vnaam = "";
    let score = 0, levens = 3, level = 1, qCorrect = 0;
    const VRAGEN = [
        { v: "Recidive betekent...", o: ["Herhaling", "Vrijspraak", "Boete"], c: 0 },
        { v: "Proportioneel handelen is...", o: ["Heel hard", "In verhouding", "Traag"], c: 1 },
        { v: "Consistent verklaren is...", o: ["Zonder fouten", "Zonder tegenstrijdigheid", "Kort"], c: 1 },
        { v: "Seponeren houdt in...", o: ["Opsluiten", "Niet vervolgen", "Dagvaarden"], c: 1 }
    ];

    // --- LOGICA ---
    function initSessie() {
        vnaam = document.getElementById('vnaam').value;
        if(!vnaam) return alert("Voornaam!");
        sRef = db.ref('ranking').push({ naam: vnaam, score: 0 });
        document.getElementById('login-screen').style.display = 'none';
        startQuiz();
        syncLeaderboard();
    }

    function syncLeaderboard() {
        db.ref('ranking').orderByChild('score').on('value', snap => {
            const list = document.getElementById('ranking-list');
            list.innerHTML = '';
            let items = [];
            snap.forEach(s => items.push(s.val()));
            items.reverse().slice(0, 15).forEach((d, i) => {
                list.innerHTML += `<div class="rank-item ${i==0?'gold':''}"><span>${i+1}. ${d.naam}</span><span>${d.score}</span></div>`;
            });
        });
    }

    function startQuiz() {
        qCorrect = 0;
        document.getElementById('quiz-box').style.display = 'block';
        document.getElementById('game-container').style.display = 'none';
        volgendeVraag();
    }

    function volgendeVraag() {
        if(qCorrect >= 5) {
            document.getElementById('quiz-box').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            document.getElementById('gameCanvas').style.display = 'block';
            initLevel();
            return;
        }
        document.getElementById('q-status').innerText = `Nog ${5-qCorrect} vragen voor herstart`;
        const q = VRAGEN[Math.floor(Math.random()*VRAGEN.length)];
        document.getElementById('vraag').innerText = q.v;
        const box = document.getElementById('optie-container'); box.innerHTML = '';
        q.o.forEach((t, i) => {
            const b = document.createElement('button'); b.className = 'optie'; b.innerText = t;
            b.onclick = () => { if(i==q.c) { qCorrect++; volgendeVraag(); } else alert("Fout!"); };
            box.appendChild(b);
        });
    }

    // --- PACMAN LEVEL ENGINE ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let dots = [], walls = [], pX, pY, gX, gY, gSpeed = 1.2;

    function initLevel() {
        dots = []; walls = [];
        pX = 200; pY = 300; gX = 200; gY = 50;
        gSpeed = 1.2 + (level * 0.4); // Spookjes worden sneller per level
        
        // Genereer muren op basis van level
        if(level === 1) walls = [{x:100, y:100, w:200, h:20}];
        if(level === 2) walls = [{x:50, y:50, w:20, h:300}, {x:330, y:50, w:20, h:300}, {x:100, y:200, w:200, h:20}];
        if(level >= 3) walls = [{x:80, y:80, w:240, h:10}, {x:80, y:300, w:240, h:10}, {x:200, y:80, w:10, h:240}];

        // Bolletjes plaatsen
        for(let i=30; i<380; i+=40) for(let j=30; j<380; j+=40) {
            if(!walls.some(w => i > w.x && i < w.x+w.w && j > w.y && j < w.y+w.h)) dots.push({x:i, y:j, e:false});
        }
        document.getElementById('lvl-val').innerText = level;
        requestAnimationFrame(draw);
    }

    function draw() {
        if(document.getElementById('game-container').style.display === 'none') return;
        ctx.fillStyle = 'black'; ctx.fillRect(0,0,400,400);

        // Muren tekenen
        ctx.fillStyle = '#2222ff';
        walls.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));

        // Bolletjes tekenen
        ctx.fillStyle = 'white';
        dots.forEach(d => {
            if(!d.e) {
                ctx.beginPath(); ctx.arc(d.x, d.y, 2, 0, 7); ctx.fill();
                if(Math.hypot(pX-d.x, pY-d.y) < 15) { d.e = true; score += 10; sRef.update({score:score}); }
            }
        });

        // Check level win
        if(dots.every(d => d.e)) { level++; alert("LEVEL COMPLETE!"); initLevel(); return; }

        // Pacman
        ctx.fillStyle = 'yellow'; ctx.beginPath(); ctx.arc(pX, pY, 12, 0.2*Math.PI, 1.8*Math.PI); ctx.lineTo(pX, pY); ctx.fill();

        // Ghost AI (Agressiever per level)
        if(gX < pX) gX += gSpeed; else gX -= gSpeed;
        if(gY < pY) gY += gSpeed; else gY -= gSpeed;
        ctx.fillStyle = 'red'; ctx.fillRect(gX-10, gY-10, 20, 20);

        // Collision
        if(Math.hypot(pX-gX, pY-gY) < 20) {
            levens--; document.getElementById('lvn-val').innerText = levens;
            if(levens <= 0) { alert("GEEN LEVENS MEER!"); location.reload(); }
            else { alert("GEPAKT! Terug naar de quiz."); startQuiz(); }
            return;
        }

        document.getElementById('scr-val').innerText = score;
        requestAnimationFrame(draw);
    }

    window.onkeydown = (e) => {
        let nX = pX, nY = pY;
        if(e.key == "ArrowLeft") nX -= 15; if(e.key == "ArrowRight") nX += 15;
        if(e.key == "ArrowUp") nY -= 15; if(e.key == "ArrowDown") nY += 15;
        // Check muur botsing
        if(!walls.some(w => nX > w.x-10 && nX < w.x+w.w+10 && nY > w.y-10 && nY < w.y+w.h+10)) { pX = nX; pY = nY; }
        if(e.key == "r") db.ref('ranking').set(null);
    };
</script>
</body>
</html>
